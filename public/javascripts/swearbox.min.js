var app=angular.module("AppISB",[]);app.service("membersService",["$http",function($http){var urlBase="/members";this.getMembers=function(){return $http.get(urlBase)},this.increaseDebt=function(id){return $http.put(urlBase+"/increase/"+id)},this.addMember=function(data){return $http.post(urlBase,data)},this.deleteMember=function(id){return $http["delete"](urlBase+"/"+id)},this.dischargeMember=function(id){return $http.put(urlBase+"/discharge/"+id,{})},this.updateNameFirstname=function(id,data){return $http.put(urlBase+"/name/"+id,data)},this.updatePicture=function(id,fd,data){return $http.put(urlBase+"/picture/"+id,fd,data)}}]),app.service("statsService",["$http",function($http){var urlBase="/stats";this.getStats=function(unit,t_unit,l_id){return $http.get(urlBase+"/"+unit+"/"+t_unit+"?ids="+l_id)},this.getAllStats=function(){return $http.get(urlBase)}}]),app.service("userService",["$http",function($http){var urlBase="/consumers";this.getAmount=function(){return $http.get("/amount")},this.updateAmount=function(data){return $http.put("/user",data)},this.getConsumers=function(){return $http.get(urlBase)},this.getConsumer=function(id){return $http.get(urlBase+id)},this.setAdmin=function(id){return $http.put(urlBase+"/admin"+id)},this.setBlacklisted=function(id){return $http.put(urlBase+"/blacklist"+id)},this.unsetBlacklisted=function(id){return $http.put(urlBase+"/unblacklist"+id)}}]),app.controller("adminCtrl",["$scope","$http","membersService","userService",function($scope,$http,membersService,userService){function getAmount(){userService.getAmount().success(function(amount){$scope.amountTag=amount}).error(function(error){alert("Unable to load amount data: "+error.message)})}function getMembers(){membersService.getMembers().success(function(membs){$scope.members=membs,getRange()}).error(function(error){alert("Unable to load members data: "+error.message)})}function getRange(){$scope.range=[];for(var i=0;i<$scope.members.length/$scope.itemsPerPage;i++)$scope.range.push(i+1)}function ModalShow(vModal){$(vModal).modal("show")}function ModalHide(vModal){$(vModal).modal("hide")}function ChargementImage(s,h){$(s).show(),$(h).hide()}$scope.idImage=0,$scope.numPage=0,$scope.itemsPerPage=5,$scope.newMember={},$scope.newMember.name="",$scope.modMember={},getMembers(),getAmount(),$scope.updateAmount=function(){var dataObj={amount:$scope.amount};userService.updateAmount(dataObj).success(function(){$scope.amountTag=$scope.amount,$scope.amount=""}).error(function(error){alert("Unable to update the penalty amount: "+error.message)})},$scope.addMember=function(){var dataObj={name:$scope.newMember.name,firstname:$scope.newMember.firstname};membersService.addMember(dataObj).success(function(){getMembers(),$scope.newMember.name="",$scope.newMember.firstname=""}).error(function(error){alert("Unable to add a new member: "+error.message)})},$scope.deleteMember=function(){$scope.members.length%$scope.itemsPerPage==1&&$scope.idx+1==$scope.members.length&&1!==$scope.members.length&&($scope.numPage=$scope.numPage-1),$scope.members.splice($scope.idx,1),membersService.deleteMember($scope.idt).success(function(){ModalHide("#deleteMember"),getMembers()}).error(function(error){alert("Unable to delete a member: "+error.message)})},$scope.dischargeMember=function(){membersService.dischargeMember($scope.idt).success(function(){ModalHide("#dischargeMember"),getMembers()}).error(function(error){alert("Unable to discharge a member: "+error.message)})},$scope.modifyMember=function(){var dataObj={name:$scope.modMember.name,firstname:$scope.modMember.firstname};membersService.updateNameFirstname($scope.idt,dataObj).success(function(){ModalHide("#modifyMember"),getMembers(),$scope.modMember.name="",$scope.modMember.firstname=""}).error(function(error){alert("Unable to update the penalty amount: "+error.message)})},$scope.onChange=function(){var file=document.getElementById("hiddenfile").files[0],fd=new FormData;ChargementImage("#span-load"+$scope.idImage,"#img"+$scope.idImage),fd.append("file",file);var dataObj={transformRequest:angular.identity,headers:{"Content-Type":void 0}};membersService.updatePicture($scope.idImage,fd,dataObj).success(function(){getMembers(),ChargementImage("#img"+$scope.idImage,"#span-load"+$scope.idImage)}).error(function(error){alert("Unable to change member picture: "+error.message)})},$scope.openDeleteModal=function(idx,idt,firstname,name){$scope.idx=idx,$scope.idt=idt,$scope.firstname=firstname,$scope.name=name,ModalShow("#deleteMember")},$scope.openDischargeModal=function(idt,firstname,name){$scope.idt=idt,$scope.firstname=firstname,$scope.name=name,ModalShow("#dischargeMember")},$scope.openModifyModal=function(idt,firstname,name){$scope.idt=idt,$scope.modMember.firstname=firstname,$scope.modMember.name=name,ModalShow("#modifyMember")},$scope.pagination=function(id){$scope.numPage=id},$scope.browseImage=function(idt){$("#hiddenfile").click(),$scope.idImage=idt},$scope.isNumeric=function(event){return(event.which<48||event.which>57)&&0!==event.which&&8!==event.which?(event.preventDefault(),!1):void 0}}]),app.controller("boCtrl",["$scope","userService",function($scope,userService){function getConsumers(){userService.getConsumers().success(function(consrs){$scope.consumers=consrs}).error(function(error){alert("Unable to load members data: "+error.message)})}getConsumers()}]),app.controller("boStatsCtrl",["$scope","$http","statsService",function($scope,$http,statsService){function loadStats(){statsService.getAllStats().success(function(data){$scope.stats=data,drawStatsD3()}).error(function(){$scope.error_title="Chargement des statistiques",$scope.error_message="Impossible de charger les données",$("#errorModal").modal("show")})}function drawStatsD3(mod){function brushed(){x.domain(brush.empty()?x2.domain():brush.extent()),focus.select(".area").attr("d",area),focus.select(".x.axis").call(xAxis)}data=$scope.stats,2==mod&&d3.select(document.getElementById("svg_id")).remove();var margin={top:10,right:10,bottom:100,left:40},margin2={top:430,right:10,bottom:20,left:40},width=document.getElementById("sub-body").offsetWidth-margin.left-margin.right,height=500-margin.top-margin.bottom,height2=500-margin2.top-margin2.bottom,parseDate=d3.time.format("%b %Y").parse,x=d3.time.scale().range([0,width]),x2=d3.time.scale().range([0,width]),y=d3.scale.linear().range([height,0]),y2=d3.scale.linear().range([height2,0]),xAxis=d3.svg.axis().scale(x).orient("bottom"),xAxis2=d3.svg.axis().scale(x2).orient("bottom"),yAxis=d3.svg.axis().scale(y).orient("left"),brush=d3.svg.brush().x(x2).on("brush",brushed),area=d3.svg.area().interpolate("monotone").x(function(d){return x(parseDate(d.date))}).y0(height).y1(function(d){return y(+d.nb)}),area2=d3.svg.area().interpolate("monotone").x(function(d){return x2(parseDate(d.date))}).y0(height2).y1(function(d){return y2(+d.nb)}),svg=d3.select(document.getElementById("sub-body")).append("svg").attr("id","svg_id").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom);svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",width).attr("height",height);var focus=svg.append("g").attr("class","focus").attr("transform","translate("+margin.left+","+margin.top+")"),context=svg.append("g").attr("class","context").attr("transform","translate("+margin2.left+","+margin2.top+")");x.domain(d3.extent(data.map(function(d){return parseDate(d.date)}))),y.domain([0,d3.max(data.map(function(d){return+d.nb}))]),x2.domain(x.domain()),y2.domain(y.domain()),focus.append("path").datum(data).attr("class","area").attr("d",area),focus.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),focus.append("g").attr("class","y axis").call(yAxis),context.append("path").datum(data).attr("class","area").attr("d",area2),context.append("g").attr("class","x axis").attr("transform","translate(0,"+height2+")").call(xAxis2),context.append("g").attr("class","x brush").call(brush).selectAll("rect").attr("y",-6).attr("height",height2+7)}$scope.stats={},loadStats(),window.onresize=function(){drawStatsD3(2)}}]),app.controller("statsCtrl",["$scope","$http","membersService","statsService",function($scope,$http,membersService,statsService){function loadMembers(){membersService.getMembers().success(function(membs){if($scope.members=membs,$scope.members.length>0){var membersToShowInChart="",counter=0;for(var i in $scope.members)counter>0&&(membersToShowInChart+=","),membersToShowInChart+=$scope.members[i].idPerson,$scope.members[i].check=!0,counter++;loadDefaultStats(membersToShowInChart)}else $scope.error_title="Chargement des membres",$scope.error_message="Impossible d'afficher les statistiques : aucun membre",$("#errorModal").modal("show")}).error(function(){$scope.error_title="Chargement des membres",$scope.error_message="Impossible de charger les données",$("#errorModal").modal("show")})}function loadDefaultStats(idMember){statsService.getStats($scope.unit,"1",idMember).success(function(data){$scope.stats=data,drawStatsD3(1)}).error(function(){$scope.error_title="Chargement des statistiques",$scope.error_message="Impossible de charger les données",$("#errorModal").modal("show")})}function drawStatsD3(mod){var names=[],j=0;for(var i in $scope.members)$scope.members[i].check&&(names[j]=$scope.members[i].firstname,j++);var data=$scope.stats,margin={top:20,right:0,bottom:30,left:0},width=document.getElementById("sub-body").offsetWidth,height=400-margin.top-margin.bottom,x0=d3.scale.ordinal().rangeRoundBands([0,width],.1),x1=d3.scale.ordinal(),y=d3.scale.linear().range([height,0]),color=d3.scale.ordinal().range(["#428bca","#5cb85c","#5bc0de","#f0ad4e","#d9534f","#8A6DE9","#444444"]),xAxis=d3.svg.axis().scale(x0).orient("bottom"),yAxis=d3.svg.axis().scale(y).orient("right").tickFormat(d3.format("d")).tickSize(width).tickSubdivide(0),tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(d){return"<strong>"+d.value+"</strong>"}),ageNames=names;data.forEach(function(d){d.ages=ageNames.map(function(name){return{name:name,value:+d[name]}})}),x0.domain(data.map(function(d){return d.Date})),x1.domain(ageNames).rangeRoundBands([0,x0.rangeBand()]),y.domain([0,d3.max(data,function(d){return d3.max(d.ages,function(d){return 1.5*d.value})})]);var date,legend;if(1==mod){var svg=d3.select(document.getElementById("sub-body")).append("svg").attr("id","svg_id").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");svg.call(tip),svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),svg.append("g").attr("class","y axis").call(yAxis).call(customAxis).append("text").attr("transform","rotate(-90)").attr("y",-15).attr("dy",".71em").style("text-anchor","end").text("Gros mots prononcés"),date=svg.selectAll(".date").data(data).enter().append("g").attr("class","g").attr("transform",function(d){return"translate("+x0(d.Date)+",0)"}),date.selectAll("rect").data(function(d){return d.ages}).enter().append("rect").attr("width",x1.rangeBand()).attr("x",function(d){return x1(d.name)}).attr("y",function(d){return y(d.value)}).attr("height",function(d){return height-y(d.value)}).style("fill",function(d){return color(d.name)}).on("mouseover",tip.show).on("mouseout",tip.hide),legend=svg.selectAll(".legend").data(ageNames.slice().reverse()).enter().append("g").attr("class","legend").attr("transform",function(d,i){return"translate(0,"+20*i+")"}),legend.append("rect").attr("x",width-18).attr("width",18).attr("height",18).style("fill",color),legend.append("text").attr("x",width-24).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(d){return d})}else if(2==mod){{var transition=d3.select(document.getElementById("svg_id")).call(tip).transition().duration(750),delay=function(){return 0};transition.selectAll(".date").delay(delay).attr("x",function(d){return x0(d.Date)})}d3.select(document.getElementById("svg_id")).selectAll("rect").remove(),date=d3.select(document.getElementById("svg_id")).selectAll(".date").data(data).enter().append("g").attr("class","g").attr("transform",function(d){return"translate("+x0(d.Date)+",0)"}),date.selectAll("rect").data(function(d){return d.ages}).enter().append("rect").on("mouseover",tip.show).on("mouseout",tip.hide).style("fill","white").style("opacity",0).transition().duration(750).style("opacity",1).attr("width",x1.rangeBand()).attr("x",function(d){return x1(d.name)}).attr("y",function(d){return y(d.value)+20}).attr("height",function(d){return height-y(d.value)}).style("fill",function(d){return color(d.name)}),d3.select(document.getElementById("svg_id")).selectAll(".legend").remove(),legend=d3.select(document.getElementById("svg_id")).selectAll(".legend").data(ageNames.slice().reverse()).enter().append("g").attr("class","legend").attr("transform",function(d,i){return"translate(0,"+20*i+")"}),legend.append("rect").style("fill","white").style("opacity",0).transition().duration(750).style("opacity",1).attr("x",width-18).attr("width",18).attr("height",18).style("fill",color),legend.append("text").transition().duration(750).attr("x",width-24).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(d){return d}),transition.select(".x.axis").call(xAxis).selectAll("g").delay(delay),transition.select(".y.axis").call(yAxis).call(customAxis).selectAll("g").delay(delay)}}function customAxis(g){g.selectAll("text").attr("x",4).attr("dy",-4)}function getMembersToShowInChart(){var membersToShowInChart="",counter=0;for(var i in $scope.members)$scope.members[i].check&&(counter>0&&(membersToShowInChart+=","),membersToShowInChart+=$scope.members[i].idPerson,counter++);return membersToShowInChart}$scope.members={},$scope.series={},loadMembers(),$scope.unit=8,$scope.loadStats=function(){var membersToShowInChart=getMembersToShowInChart();""!==membersToShowInChart?(document.getElementById("weeks").checked&&($scope.type_unit=1),document.getElementById("months").checked&&($scope.type_unit=2),statsService.getStats($scope.unit,$scope.type_unit,membersToShowInChart).success(function(data){$scope.stats=data,drawStatsD3(2)}).error(function(){$scope.error_title="Paramétrage des statistiques",$scope.error_message="Impossible de charger les données",$("#errorModal").modal("show")})):($scope.error_title="Paramétrage des statistiques",$scope.error_message="Au moins un membre doit être sélectionné.",$("#errorModal").modal("show"))},window.onresize=function(){drawStatsD3(2)},$scope.refreshMembersChecked=function(idt){for(var i in $scope.members)$scope.members[i].idPerson==idt&&($scope.members[i].check=$scope.members[i].check?!1:!0);$scope.loadStats()}}]),app.controller("userCtrl",["$scope","membersService","userService",function($scope,membersService,userService){function getAmount(){userService.getAmount().success(function(amount){$scope.amountTag=amount}).error(function(error){alert("Unable to load amount data: "+error.message)})}function getMembers(){membersService.getMembers().success(function(membs){$scope.members=membs,getRange()}).error(function(error){alert("Unable to load members data: "+error.message)})}function getRange(){$scope.range=[];for(var i=0;i<$scope.members.length/$scope.itemsPerPage;i++)$scope.range.push(i+1)}$scope.numPage=0,$scope.itemsPerPage=5,$scope.amountTag="",getAmount(),getMembers(),$scope.increase=function(id){for(var i in $scope.members)$scope.members[i].idPerson==id&&($scope.members[i].debt+=$scope.amountTag);membersService.increaseDebt(id).success(function(){}).error(function(error){getMembers(),alert("Unable to increase member debt: "+error.message)})},$scope.pagination=function(id){$scope.numPage=id}}]);